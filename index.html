<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Forest Fairy Gemstone Game</title>

    <!-- iOS homeâ€‘screen icon (180â€¯Ã—â€¯180 PNG of the fairy) -->
    <link rel="apple-touch-icon" sizes="180x180" href="fairy-icon-180.png" />
    <!-- Optional PWA manifest for Android / desktop -->
    <link rel="manifest" href="manifest.json" />

    <style>
      /* ============ Layout ============ */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        touch-action: none;
        -webkit-user-select: none;
        user-select: none;
        font-family: system-ui, -apple-system, sans-serif;
      }
      #game {
        position: relative;
        width: 100%;
        height: 100%;
        background: url('background.png') repeat;
        background-size: contain;
      }

      /* ============ Sprites ============ */
      .fairy {
        position: absolute;
        width: 96px;
        height: 96px;
        background: url('sprite.png') center/contain no-repeat;
        pointer-events: auto;
        touch-action: none;
      }
      .gem {
        position: absolute;
        width: 64px;
        height: 64px;
        background: url('gemstone.png') center/contain no-repeat;
        pointer-events: none;
      }

      /* ============ UI ============ */
      #scoreBox {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
        background: rgba(255, 255, 255, 0.75);
        padding: 4px 12px;
        border-radius: 12px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
      }
      #resetBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 16px;
        background: #d9534f;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 6px 10px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.25);
      }
      #soundBtn {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 20px;
        background: #5bc0de;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.25);
      }
    </style>
  </head>
  <body>
    <div id="game">
      <div id="scoreBox">Gems: <span id="score">0</span></div>
      <button id="soundBtn" title="Toggle music">ðŸ”Š</button>
      <button id="resetBtn" title="Start over">Reset</button>

      <!-- Audio sources -->
      <audio id="bgm" src="forest-fairy-110537.mp3" loop></audio>
      <audio id="sfx" src="plop.mp3" preload="auto"></audio>
      <!-- gemâ€‘collect sound -->
    </div>

    <script>
      /* =============================================================
     Forest Fairy Gemstone Game â€“ v10  (uses plop.mp3 for SFX)
  ============================================================= */

      /* ---------- DOM refs ---------- */
      const game = document.getElementById('game');
      const scoreSpan = document.getElementById('score');
      const resetBtn = document.getElementById('resetBtn');
      const soundBtn = document.getElementById('soundBtn');
      const bgm = document.getElementById('bgm');
      const sfx = document.getElementById('sfx');
      sfx.volume = 0.5; // 50Â % volume

      /* ---------- Helpers ---------- */
      const rand = (m) => Math.random() * m;
      const rect = (e) => {
        const r = e.getBoundingClientRect();
        return { x: r.left, y: r.top, w: r.width, h: r.height };
      };
      const hits = (a, b) =>
        a.x < b.x + b.w &&
        a.x + a.w > b.x &&
        a.y < b.y + b.h &&
        a.y + a.h > b.y;

      /* ---------- Persistence keys ---------- */
      const SAVE_KEY = 'ffgg_state';
      const SOUND_KEY = 'ffgg_sound';

      /* ---------- Music / mute ---------- */
      bgm.volume = 0.4;
      bgm.muted = localStorage.getItem(SOUND_KEY) === 'muted';
      sfx.muted = bgm.muted;
      updateSoundBtn();
      bgm.play().catch(() => {});
      game.addEventListener(
        'pointerdown',
        () => {
          if (!bgm.muted) bgm.play().catch(() => {});
        },
        { once: true }
      );
      soundBtn.addEventListener('click', () => {
        bgm.muted = !bgm.muted;
        sfx.muted = bgm.muted;
        localStorage.setItem(SOUND_KEY, bgm.muted ? 'muted' : 'unmuted');
        updateSoundBtn();
        if (!bgm.muted) bgm.play().catch(() => {});
      });
      function updateSoundBtn() {
        soundBtn.textContent = bgm.muted ? 'ðŸ”‡' : 'ðŸ”Š';
      }

      /* ---------- Game state ---------- */
      let score = 0;
      const fairies = [];

      class Fairy {
        constructor(x, y) {
          this.el = document.createElement('div');
          this.el.className = 'fairy';
          this.el.style.left = x + 'px';
          this.el.style.top = y + 'px';
          game.appendChild(this.el);
          this.prevX = x;
          this.prevY = y;
          this.pointerId = null;
          this.enableDrag();
          this.startIdle();
        }
        enableDrag() {
          this.el.addEventListener('pointerdown', (e) => {
            this.pointerId = e.pointerId;
            this.move(e.clientX, e.clientY, true);
            e.stopPropagation();
          });
          window.addEventListener('pointermove', (e) => {
            if (e.pointerId === this.pointerId)
              this.move(e.clientX, e.clientY, true);
          });
          ['pointerup', 'pointercancel', 'pointerleave'].forEach((t) =>
            window.addEventListener(t, (e) => {
              if (e.pointerId === this.pointerId) this.pointerId = null;
            })
          );
        }
        move(cx, cy, prop) {
          const fW = this.el.offsetWidth,
            fH = this.el.offsetHeight,
            maxX = game.clientWidth - fW,
            maxY = game.clientHeight - fH;
          const nx = Math.max(0, Math.min(cx - fW / 2, maxX)),
            ny = Math.max(0, Math.min(cy - fH / 2, maxY));
          const dx = nx - this.prevX,
            dy = ny - this.prevY;
          if (!dx && !dy) return;
          this.prevX = nx;
          this.prevY = ny;
          this.el.style.left = nx + 'px';
          this.el.style.top = ny + 'px';
          checkGems();
          if (prop)
            fairies.forEach((f) => {
              if (f !== this && hits(rect(this.el), rect(f.el)))
                f.nudge(dx, dy);
            });
        }
        nudge(dx, dy) {
          const r = rect(this.el);
          this.move(r.x + r.w / 2 + dx, r.y + r.h / 2 + dy, false);
        }
        startIdle() {
          const loop = () => {
            if (!this.pointerId) {
              const amp = 6 + rand(12),
                dur = 250 + rand(250);
              this.el.animate(
                [
                  { transform: 'translateY(0)' },
                  { transform: `translateY(-${amp}px)` },
                ],
                {
                  duration: dur,
                  direction: 'alternate',
                  iterations: 2,
                  easing: 'ease-out',
                }
              );
            }
            this.timer = setTimeout(loop, 1500 + rand(3000));
          };
          this.timer = setTimeout(loop, rand(2000));
        }
        destroy() {
          clearTimeout(this.timer);
          this.el.remove();
        }
      }

      /* ---------- Gems ---------- */
      function spawnGem() {
        const g = document.createElement('div');
        g.className = 'gem';
        g.style.left = rand(game.clientWidth - 64) + 'px';
        g.style.top = rand(game.clientHeight - 64) + 'px';
        game.appendChild(g);
      }
      function checkGems() {
        document.querySelectorAll('.gem').forEach((g) => {
          if (fairies.some((f) => hits(rect(f.el), rect(g)))) collect(g);
        });
      }
      function collect(g) {
        g.remove();
        score++;
        scoreSpan.textContent = score;
        localStorage.setItem(SAVE_KEY, JSON.stringify({ score }));
        if (!bgm.muted) {
          sfx.currentTime = 0;
          sfx.play().catch(() => {});
        }
        if (score % 100 === 0) addFairy();
      }

      /* ---------- Spawners ---------- */
      function addFairy() {
        fairies.push(
          new Fairy(
            game.clientWidth / 2 - 48 + rand(40) - 20,
            game.clientHeight * 0.7 - 48 + rand(40) - 20
          )
        );
      }

      /* ---------- Init ---------- */
      (function () {
        const saved = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
        if (saved && saved.score) score = saved.score;
        scoreSpan.textContent = score;
        addFairy();
        for (let i = 1; i < Math.floor(score / 100) + 1; i++) addFairy();
        spawnGem();
        setInterval(spawnGem, 1800);
      })();

      /* ---------- Reset ---------- */
      resetBtn.addEventListener('click', () => {
        document.querySelectorAll('.gem').forEach((g) => g.remove());
        fairies.forEach((f) => f.destroy());
        fairies.length = 0;
        score = 0;
        scoreSpan.textContent = '0';
        localStorage.removeItem(SAVE_KEY);
        addFairy();
      });

      /* ---------- Resize guard ---------- */
      window.addEventListener('resize', () => {
        fairies.forEach((f) => {
          const r = rect(f.el);
          f.move(r.x + r.w / 2, r.y + r.h / 2, false);
        });
      });
    </script>
  </body>
</html>
